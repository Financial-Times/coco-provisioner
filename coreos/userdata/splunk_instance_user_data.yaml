#cloud-config

coreos:
  update:
    reboot-strategy: best-effort
  etcd:
    discovery: {{token}}
    addr: $private_ipv4:4001
    peer-addr: $private_ipv4:7001
    # give etcd more time if it's under heavy load - prevent leader election thrashing
    peer-election-timeout: 2000
    # heartbeat interval should ideally be 1/4 or 1/5 of peer election timeout
    peer-heartbeat-interval: 500
  fleet:
    # allow etcd to slow down at times
    etcd_request_timeout: 3.0
    metadata: host_type=splunk
  units:
    - name: etcd.service
      command: start
    - name: fleet.service
      command: start
    - name: makefs.service
      command: start
      content: |
        [Unit]
        Before=media-test.mount
        [Service]
        Type=oneshot
        ExecStart=/bin/bash -c "/usr/sbin/fsck /dev/xvdf || /usr/sbin/mkfs.ext4 /dev/xvdf"
        ExecStart=/bin/bash -c "/usr/bin/test -e /media/test || /usr/bin/mkdir /media/test"
    - name: media-test.mount
      command: start
      content: |
        [Mount]
        What=/dev/xvdf
        Where=/media/test
        Type=ext4
write_files:
  - path: /etc/systemd/system/fleet.socket.d/30-ListenStream.conf
    content: |
      [Socket]
      ListenStream=0.0.0.0:49153

